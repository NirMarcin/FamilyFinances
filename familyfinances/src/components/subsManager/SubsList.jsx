import React, { useContext, useState } from "react";
import UniversalList from "../common/UniversalList";
import SubsContext from "../../contexts/SubsContext";
import ModalDetails from "../modals/ModalDetails";

function getMonthsActive(startDate) {
  const start = new Date(startDate);
  const now = new Date();
  return (
    (now.getFullYear() - start.getFullYear()) * 12 +
    (now.getMonth() - start.getMonth()) +
    (now.getDate() >= start.getDate() ? 0 : -1)
  );
}

function getNextPaymentDate(date, interval) {
  const start = new Date(date);
  const now = new Date();
  let monthsPassed = getMonthsActive(date);
  let next = new Date(start);
  next.setMonth(
    start.getMonth() + Math.ceil((monthsPassed + 1) / interval) * interval
  );
  if (next < now) next.setMonth(next.getMonth() + interval);
  return next.toLocaleDateString("pl-PL");
}

export default function SubsList() {
  const { subs, deleteSub, disableSub } = useContext(SubsContext);

  // Stan modali
  const [modalDisable, setModalDisable] = useState(null);

  // Pokaż tylko subskrypcje aktywne
  const activeSubs = subs.filter((sub) => sub.active !== false);

  // Unikalne subskrypcje po nazwie
  const uniqueSubs = Object.values(
    activeSubs.reduce((acc, sub) => {
      // Jeśli subskrypcja już istnieje, wybierz tę z najwcześniejszą datą
      if (
        !acc[sub.subscriptionId] ||
        new Date(sub.date) < new Date(acc[sub.subscriptionId].date)
      ) {
        acc[sub.subscriptionId] = { ...sub, subscriptionInfo: "" };
      }
      return acc;
    }, {})
  );

  if (!uniqueSubs.length) {
    return (
      <section className="mt-10 p-5 border border-gray-300 dark:border-gray-800 rounded-lg bg-orange-50 dark:bg-black shadow-inner transition-colors duration-300">
        <h2 className="text-2xl font-extrabold mb-6 text-orange-700 dark:text-orange-400 text-center">
          Aktywne subskrypcje
        </h2>
        <p className="text-center text-gray-500 dark:text-orange-300">
          Brak aktywnych subskrypcji.
        </p>
      </section>
    );
  }

  return (
    <section className="mt-10 p-5 border border-gray-300 dark:border-gray-800 rounded-lg bg-orange-50 dark:bg-black shadow-inner transition-colors duration-300 dark:text-orange-300">
      <h2 className="text-2xl font-extrabold mb-6 text-orange-700 dark:text-orange-400 text-center">
        Aktywne subskrypcje
      </h2>
      <UniversalList
        data={uniqueSubs}
        columns={[
          {
            key: "subscriptionInfo",
            label: "Subskrypcja",
            render: (item) => (
              <div>
                <div>
                  <span className="font-semibold ">Rozpoczęcie: </span>
                  {item.startDate
                    ? new Date(item.startDate).toLocaleDateString("pl-PL")
                    : "-"}
                </div>
                <div>
                  <span className="font-semibold">Trwa: </span>
                  {item.startDate
                    ? getMonthsActive(item.startDate) + " mies."
                    : "-"}
                </div>
                <div>
                  <span className="font-semibold ">Kolejna płatność: </span>
                  {getNextPaymentDate(item.date, item.interval)}
                </div>
              </div>
            ),
          },
          { key: "name", label: "Nazwa" },
          { key: "category", label: "Kategoria" },
          {
            key: "amount",
            label: "Kwota (zł)",
            align: "text-right",
            render: (item) => (
              <span className="text-orange-700 dark:text-orange-300 font-semibold">
                {Number(item.amount).toFixed(2)} zł
              </span>
            ),
          },
          {
            key: "interval",
            label: "Interwał (mies.)",
            align: "text-center",
          },
          {
            key: "actions",
            label: "Akcje",
            render: (item) =>
              item.active !== false ? (
                <button
                  className="bg-red-200 hover:bg-red-400 dark:bg-red-900 dark:hover:bg-red-700 text-red-800 dark:text-orange-300 font-bold py-1 px-4 rounded shadow transition-colors duration-300"
                  onClick={() => setModalDisable(item)}
                >
                  Wyłącz
                </button>
              ) : (
                <span className="text-gray-400 dark:text-gray-500 font-semibold dark:text-orange-300">
                  Wyłączona
                </span>
              ),
          },
        ]}
        onDelete={(item) => {
          subs
            .filter((sub) => sub.subscriptionId === item.subscriptionId)
            .forEach((sub) => deleteSub(sub.id));
        }}
        deleteConfirmTitle="Potwierdź usunięcie"
        deleteConfirmMessage={
          <>
            Czy na pewno chcesz usunąć tę subskrypcję?
            <br />
            <span className="pl-4 block text-gray-500 dark:text-orange-300">
              Usunięcie jest nieodwracalne i usunie wszystkie dodane płatności.
            </span>
          </>
        }
      />

      {/* Modal potwierdzający wyłączenie */}
      {modalDisable && (
        <ModalDetails
          title="Potwierdź wyłączenie"
          onClose={() => setModalDisable(null)}
        >
          <div>
            Czy na pewno chcesz wyłączyć tę subskrypcję?
            <br />
            <span className="pl-4 block text-gray-500 dark:text-orange-300">
              Wyłączona subskrypcja nie będzie już generować nowych płatności.
            </span>
            <div className="flex justify-end gap-4 mt-6">
              <button
                className="bg-gray-300 hover:bg-gray-400 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-800 dark:text-orange-300 font-bold py-2 px-6 rounded shadow transition-colors duration-300"
                onClick={() => setModalDisable(null)}
              >
                Anuluj
              </button>
              <button
                className="bg-orange-500 hover:bg-orange-700 dark:bg-orange-700 dark:hover:bg-orange-800 text-white dark:text-orange-200 font-bold py-2 px-6 rounded shadow transition-colors duration-300"
                onClick={() => {
                  disableSub(modalDisable.subscriptionId);
                  setModalDisable(null);
                }}
              >
                Wyłącz
              </button>
            </div>
          </div>
        </ModalDetails>
      )}
    </section>
  );
}
